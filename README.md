# natural-env-generation

## Pipeline Overview

    1. Generate heightmap using fractal Brownian motion noise (macro + meso scale).
    2. Convert heightmap to mesh (.obj) and then to USD format.
    3. Assign cube-mapped UVs and apply PBR material.
    4. Build semantic map for vegetation type distribution.
    5. Generate scatter points for grass (random) and trees (Poisson disk).
    6. Instance vegetation assets into the scene and place the robot with sensors.
    7. Start simulation with terrain and vegetation streaming based on robot position.

## Current Features

* Procedural Generation of terrain using Nvidia FBM noise
* Random/poisson Scattering across environment
* Semantic Map noise for:
    - "patchy" style grass models using probability
    - Scaling based on local density using a convolution filter
* Realtime LOD/tile streaming based on robot position for world optimization

## TO-DO

* IMU currently displays angular velocity on isaac sim viewport -> publish IMU properties on ROS2
* Lidar is active but does not display or publish to ROS during runtime
* Husky Front Camera is active but does not display or publish to ROS during runtime
* Tree models probability still not pseudo-random


## Installation 

```
conda create -n isaacenv python=3.10
conda activate isaacenv
pip install -r requirements.txt
```


## Run

In a new terminal, run the following commands:

```
source /opt/ros/humble/setup.sh
conda activate isaacenv
export RMW_IMPLEMENTATION=rmw_fastrtps_cpp
```

If there is an issue with isaacsim not finding ```GLIBCXX_3.4.30```, it might be due to a conflicting ```libstdc++.so.6``` from the conda environment. A temporary fix is to move the ```libstdc++.so.6``` to a backup and deafault to using the ```GLIBCXX_3.4.30``` from Ubuntu. <!--revert to this later--> 

```
mv ~/miniconda3/envs/isaacenv/lib/libstdc++.so.6 ~/miniconda3/envs/isaacenv/lib/libstdc++.so.6.bak
export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
```

Then run the script: 
```
cd natural-env-generation
python main.py
```

## Structure Requirements

make sure to have the following folders with corresponding elements inside:

```
natural-env-generation/output: empty folder (cache folder). Empty on new runs
natural-env-generation/hdri: include at least 1 hdri 
natural-env-generation/textures: include any model texture which hasnt gone through LOD.py
natural-env-generation/assets: refer to main.py for folder structure
```
## Customizing Assets

by default, the main structure for models follows the below hierarchy:

```
- Grass: 
    folder directory: natural-env-generation/assets/models/grass
    textures directory: natural-env-generation/assets/models/grass/textures
    LOD implementation: follow instructions inside LOD.py

- Trees:
    folder directory: natural-env-generation/assets/models/trees
    textures directory: natural-env-generation/textures
    LOD implementation: No current LOD feature

- Robot:
    folder directory: natural-env-generation/assets/robots

- Terrain Textures:
    folder directory: natural-env-generation/assets/textures
```
## Main Scripts purposes:

* LOD.py
```
Standalone script to convert models into Isaac Sim-supported LOD variant models.

Purpose:
    Converts high- and low-detail model variants into a single USD file
    with proper LOD setup for use in Isaac Sim.
```

* main.py:
```
Main entry point for procedural terrain generation, vegetation instancing,
runtime streaming, and ROS2-enabled simulation in NVIDIA Isaac Sim.
```

* fbm.py:
```
Generates procedural heightmaps using Fractal Brownian Motion (FBM) noise
on the GPU via NVIDIA Warp.

Purpose in Pipeline:
    - Used in Step 3 of main.py to produce macro- and meso-scale terrain features.
    - Outputs a 2D NumPy array (.npy) representing the heightmap.
```

* terrain_mesh.py
```
Converts a .npy heightmap (generated by fbm.py) into a 3D mesh (.obj) with optional
micro-displacement for fine surface detail.

Purpose in Pipeline:
    - Step 4 in main.py: transforms heightmap data into geometry for Isaac Sim.
    - Produces an .obj file for later conversion to USD.
    - Adds high-frequency surface details (micro-displacement) from a grayscale texture.
```

* asset_usd_converter.py
```
Converts 3D assets (e.g., .obj meshes) into USD format compatible with Isaac Sim.

Purpose in Pipeline:
    - Step 5 in main.py: takes the OBJ mesh generated by terrain_mesh.py
      and converts it into a USD stage that Isaac Sim can load.
    - Uses NVIDIA Omniverse's omni.kit.asset_converter extension.
```

* texture_bind.py
```
Generates and assigns UV coordinates to a terrain mesh in USD format,
allowing materials and textures to be correctly projected onto it.

Purpose in Pipeline:
    - Step 6 in main.py: after converting the OBJ mesh to USD,
      this step assigns UV mapping so textures align correctly in Isaac Sim.
    - Uses cube projection (X/Y planar projection) to generate UVs.
```

* material_assign.py
```
Creates and assigns a PBR (Physically Based Rendering) material to a terrain mesh
in USD format for use in Isaac Sim.

Purpose in Pipeline:
    - Step 6 (after texture_bind.py) in main.py: applies textures to the terrain mesh.
    - Uses UsdPreviewSurface shader with albedo, roughness, and normal maps.
```

* generate_semantic_map.py
```
------------------------
Generates a semantic map for vegetation placement by assigning vegetation
types and scale classes to each pixel in the terrain.

Purpose in Pipeline:
    - Step 7 in main.py: determines where and how vegetation will be placed.
    - Uses procedural noise to vary vegetation type and density across the map.
    - Encodes vegetation model ID and scale class into a 2-channel map.
```

* random_generation.py
```
Generates dense random scatter points for vegetation placement, such as grass.
Produces a similar output format to Poisson disk sampling but uses uniform random
generation for speed.

Purpose in Pipeline:
    - Step 8 (grass scattering) in main.py.
    - Ideal for dense vegetation (e.g., grass) where Poisson disk sampling
      would be too slow.
    - Produces per-tile point buckets for efficient streaming and instancing.
```

* poisson.py
```
Generates Poisson disk sample points for vegetation scattering, such as trees,
ensuring a minimum spacing between points to avoid clustering.

Purpose in Pipeline:
    - Step 8 (tree scattering) in main.py.
    - Produces evenly spaced vegetation placement points for sparser objects
      like trees, where uniform randomness would cause unrealistic clustering.
    - Stores results in a per-tile dictionary for efficient streaming.
```

* instancing.py
```
Handles placement and instancing of grass, trees, robot, and sensors
in Isaac Sim using USD PointInstancer primitives.

Also responsible for:
    - Applying vegetation orientation based on terrain normals.
    - Scaling vegetation based on semantic map classes.
    - Random variation for natural look.
    - HDRI dome lighting.
    - Robot placement and ROS2-enabled sensor setup (LiDAR + RGB camera).

Purpose in Pipeline:
    - Step 9 in main.py: after terrain, semantic map, and vegetation points
      have been generated, this module populates the scene.
    - Produces all visible environmental assets and robot sensors for the simulation.
```

* terrain_streamer.py
```
Manages runtime loading and unloading of terrain tiles in Isaac Sim.

Purpose in Pipeline:
    - Step 10 in main.py: used during simulation runtime to:
        1. Determine which tiles need to be generated based on robot position.
        2. Unload tiles outside the visible radius to free resources.
        3. Switch vegetation LOD for tiles outside close view range.
```

* vegetation_streamer.py
```
Manages runtime loading and unloading of vegetation tiles in Isaac Sim.

Purpose in Pipeline:
    - Step 11 in main.py: works alongside terrain_streamer.py to:
        1. Determine which vegetation instancers (grass + trees) need to be active.
        2. Spawn vegetation for newly loaded terrain tiles.
        3. Remove vegetation instancers for tiles outside the visible radius.
```